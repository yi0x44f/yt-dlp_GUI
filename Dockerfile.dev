# syntax=docker/dockerfile:1
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  PHP-FPM åŸºåº•ï¼ˆDebian Bookwormï¼‰              â”‚
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FROM php:8.3-fpm

# 1. ç³»çµ±å·¥å…· + å¿…è¦ dev å¥—ä»¶
RUN apt-get update -y && apt-get install -y \
        git curl unzip \
        libzip-dev zlib1g-dev \          
    && rm -rf /var/lib/apt/lists/*

RUN apt-get update && apt-get install -y python3 python3-pip

# 2. Composerï¼ˆç”¨å®˜æ–¹ multi-stage æŠ“æœ€ä¹¾æ·¨ï¼‰
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

# 3. yt-dlp åˆ° PATH
COPY yt-dlp /usr/local/bin/
RUN chmod +x /usr/local/bin/yt-dlp

RUN apt-get update && apt-get install -y ffmpeg

# 4. å°ˆæ¡ˆç¨‹å¼ç¢¼
WORKDIR /var/www
COPY . .

# 5. å®‰è£ PHP ä¾è³´
RUN composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

# 6. ï¼ˆå¯é¸ï¼‰è‹¥ä½ è¦åœ¨æ˜ åƒè£¡ç›´æ¥ build å‰ç«¯éœæ…‹æª”ï¼Œè§£é™¤è¨»è§£ğŸ‘‡
# RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
#     && apt-get install -y nodejs \
#     && npm ci && npm run build && npm cache clean --force

RUN php artisan storage:link
RUN php artisan key:generate
# 7. ä½ˆç½²æ™‚åªè¦ä¸€è¡ŒæŒ‡ä»¤æŠŠ Laravel è·‘èµ·ä¾†
EXPOSE 8000
CMD ["php", "artisan", "serve", "--host=0.0.0.0", "--port=8000"]
